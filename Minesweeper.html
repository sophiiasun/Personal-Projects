<!DOCTYPE html>
<html>
<head>
<script type="text/javascript">
    var game 
    var numB
    var width, height
    var qZero = []
    var grid
    var bLoc = []
    var bCnt = 0
    function createGrid(){
        width = parseInt(document.getElementById("width").value)
        height = parseInt(document.getElementById("height").value)
        game = new Array(height)
        for(var i = 0; i < height; i++) {
            game[i] = new Array(width)
        }
        drawGrid()
        addBomb()
        fillGrid()
        debug()
    }
    function revealBomb() {
        var tmpR, tmpC
        for (var i = 0; i < bLoc.length; i++) {
            tmpR = bLoc[i][0] 
            tmpC = bLoc[i][1]
            var strB = tmpR +  "-" + tmpC   
            document.getElementById(strB).value = 'X'
        }   
    }   
    function drawGrid(){
        grid = document.getElementById("grid")
        if(width<10 || height<10) {
            alert("Minimum value for width and height is 10.")
            return;
        }
        var value="<table style='border-collapse:collapse;border-style:inset'>"
        for(var i = 0; i < height; i++) {
            value+="<tr>"
            for(var j = 0; j < width; j++) {
                value+="<td id='"+i+"="+j+"'style='line-height:0px;padding:0px;border-style:inset;text-align:center'>"
                value+="<input type='button' style='width:30px; height:30px; font-weight:bold' id='"+i+"-"+j+"' onmousedown=whichMouse(this,event)>"
                value+="</td>"
            }
            value+="</tr>"
        }
        value+="</table>"
        grid.innerHTML=value
    }
    function whichMouse(button, event) {
        var temp = button.id
        var h = parseInt(temp.slice(0, 1))
        var w = parseInt(temp.slice(2))
        if (event.shiftKey) {
            var btn = document.getElementById(temp)
            if (document.getElementById(temp).value == 'X') {
                document.getElementById(temp).value = ''
            } else {
                document.getElementById(temp).value = 'X'
            }
            if (bCnt == numB) {
                alert("You're won! Start a new game.")
            }
        } else {
            clickButton(button)
        } 
    }
    function addBomb(){
        numB = Math.round(width * height * 0.15)
        for(var i = 0; i < numB; i++) {
            var tmpR = Math.round(Math.random() * (height-1))
            var tmpC = Math.round(Math.random() * (width-1))
            if(game[tmpR][tmpC] != -1) {
                game[tmpR][tmpC] = -1
                bLoc.push([tmpR, tmpC])
            } else {
                i--;
            }
        }
    }
    function fillGrid() {
        for(var i = 0; i < height; i++) {
            for(var j = 0; j < width; j++) {
                if (game[i][j] == -1) {
                    continue
                } else {
                    game[i][j] = chkArea(i, j)
                }
            }
        }
    }
    function chkArea(H, W) {
        var counter = 0;
        if (H - 1 >= 0) { 
            if (W - 1 >= 0) {
                if (game[H-1][W-1] == -1) 
                    counter++;
            }
            if (game[H-1][W] == -1)
                counter++;
            if (W + 1 < width) {
                if (game[H-1][W+1] == -1)
                    counter++;
            }
        }
        if (W - 1 >= 0) {
            if (game[H][W-1] == -1)
                counter++
        }
        if (W + 1 < width) {
            if (game[H][W+1] == -1)
                counter++
        }
        if (H + 1 < height) {
            if (W - 1 >= 0) {
                if (game[H+1][W-1] == -1)
                    counter++
            }
            if (game[H+1][W] == -1)
                counter++
            if (W + 1 < width) {
                if (game[H+1][W+1] == -1)
                    counter++
            }
        }
        return counter
    }
    function debug() { 
        var debug = document.getElementById("debug")
        var debuginfo = ""
        for (var i = 0; i < height; i++) {
            for(var j = 0; j < width; j++) 
                debuginfo+=game[i][j] + " "
            debuginfo+="<br>"
        }
        debug.innerHTML = debuginfo
    }
    function clickButton(button) {
        var temp = button.id
        var h = parseInt(temp.slice(0, 1))
        var w = parseInt(temp.slice(2))
        var val = game[h][w]
        if (val == -1) {
            revealBomb()
            alert("You've Lost!") 
        } else if (val == 0) floodFill(h, w)
        else if (val >= 1) revealValue(h, w)
    }
    function floodFill(h, w) {
        var temp = []  
        revealValue(h, w)
        game[h][w] = -2
        qZero.push([h, w])
        while (qZero.length > 0) {
            temp = qZero.shift()
            if (temp[0] - 1 >= 0) {
                if (temp[1] - 1 >= 0) chkVal(temp[0] - 1, temp[1] - 1)
                if (temp[1] + 1 < width) chkVal(temp[0] - 1, temp[1] + 1)
                chkVal(temp[0] - 1, temp[1])
            }
            if (temp[1] - 1 >= 0) chkVal(temp[0], temp[1] - 1)
            if (temp[1] + 1 < width) chkVal(temp[0], temp[1] + 1)
            if (temp[0] + 1 < height) {
                if (temp[1] - 1 >= 0) chkVal(temp[0] + 1, temp[1] - 1)
                if (temp[1] + 1 < width) chkVal(temp[0] + 1, temp[1] + 1)
                chkVal(temp[0] + 1, temp[1])
            }
        }
    }
    function chkVal(h, w) {
        if (game[h][w] == 0) 
            qZero.push([h, w])
        if (game[h][w] == -2) return
        revealValue(h, w)
        game[h][w] = -2
    }
    function revealValue(h, w) {
        var strB = h +  "-" + w
        document.getElementById(strB).style.visibility = 'hidden'
        if (game[h][w] >= 1) { 
            var strG = h + "=" + w
            document.getElementById(strG).innerHTML = game[h][w]
        }
    }
</script>
</head>
<body>
    <h2> MINESWEEPER </h2>
    Width: <input id="width" value="20">

    Height: <input id="height" value="20">
    <input type="button" value="Create" onclick="createGrid()">
    <p> 
    <div id="grid"> </div>
    </p>
</body>
<div id="debug"></div>
</html>